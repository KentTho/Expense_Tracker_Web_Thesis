Tuyệt — mình đã kiểm tra toàn bộ phần Income trong `main.py` bạn gửi trước đó. Dưới đây mình tóm tắt những gì hiện có, những lỗ hổng / cải tiến nên làm, và kèm các đoạn code sửa đề xuất để bạn có thể cập nhật nhanh. Sau khi bạn đồng ý kết thúc backend, mình sẵn sàng nhận phần FE để hoàn thiện phần giao tiếp (calls / xử lý lỗi / UI).

---

# 1) Tóm tắt những endpoint Income bạn đã có

Bạn đã có những route chính sau (và hầu hết logic đã dùng `Depends(get_current_user_db)`):

 `POST /incomes` — tạo income (dùng `IncomeCreate`, trả `IncomeOut`)
 `GET  /incomes` — list incomes (trả `List[IncomeOut]`)
 `PUT  /incomes/{income_id}` — cập nhật (hiện nhận `update_data: dict`)
 `DELETE /incomes/{income_id}` — xóa
 `GET  /export/income` — export incomes -> excel (StreamingResponse)

Ngoài ra analytics/trends và transactions/summary cũng sử dụng income tổng hợp ở chỗ khác.

→ Về mặt chức năng cơ bản: đã đầy đủ (CRUD + export + list + summary). Tuy nhiên có một vài điểm cần cải thiện để an toàn, nhất quán và production-ready.

---

# 2) Vấn đề / cải tiến mình khuyến nghị (chi tiết)

Mình chia theo mục — ưu tiên sửa trước các chỗ rủi ro.

### A. Validation & request types

 Hiện `PUT /incomes/{income_id}` nhận `update_data: dict`. Tốt hơn hãy có `IncomeUpdate` Pydantic model (với `Optional` fields). Giữ typed models giúp tự validate, sinh docs, tránh lỗi runtime.
 Validate `amount` kiểu `Decimal` (không dùng float để tránh lỗi làm tròn). Pydantic + SQLAlchemy nên dùng `Decimal`/`Numeric` trong model/schema.

### B. HTTP status codes & RESTful best-practices

 `POST /incomes` nên trả `status_code=201` (Created) và trả object mới. Khuyến nghị thêm `Location` header (URL tới resource).
 `DELETE` nên trả `204 No Content` khi thành công (hoặc vẫn trả message 200 nếu bạn muốn).

### C. Authorization / Ownership checks

 Đảm bảo `crud.update_income` & `crud.delete_income` kiểm tra user_id (chỉ owner mới sửa/xóa). Nếu hiện crud chưa kiểm tra, route phải kiểm tra trước khi gọi update/delete.

### D. DB transaction atomicity & error handling

 Catch DB exceptions (e.g., IntegrityError) và trả `HTTPException(500/400)` rõ ràng.
 Đảm bảo `crud.create_income` commit/rollback đúng. Nếu chưa, wrap DB changes trong transaction.

### E. Timestamps / timezone

 `date` field: rõ ràng về timezone / date-only vs datetime. Nếu bạn dùng `date` (không thời gian) thì Pydantic `date` ok; nếu dùng datetime thì cần timezone-aware datetimes.

### F. Pagination / filtering

 `GET /incomes` nên hỗ trợ filter (by `from_date`, `to_date`) và pagination (limit, offset / page). Nếu dataset lớn, list toàn bộ sẽ chậm.

### G. Response consistency

 Một số route trả dict `{"message":...}`; một số trả model. Mình đề xuất trả model đối với create/update, và trả 204 cho delete.

### H. Logging & monitoring

 Thêm logging (không print) để debug production.

### I. Tests

 Unit tests cho CRUD, integration tests cho endpoints.

---

# 3) Đoạn code đề xuất — thay thế/hoàn thiện phần Income (copy vào main hoặc file route tương ứng)

Dưới đây là phiên bản cải tiến cho endpoints income — dùng `IncomeUpdate` mẫu, status codes chuẩn, xử lý lỗi và ownership check. Bạn đã có `IncomeCreate`/`IncomeOut` trong `schema.py`; mình giả sử thêm `IncomeUpdate` (tất cả fields optional).

## a) Schema (schemas.py) — thêm IncomeUpdate

```python
from pydantic import BaseModel, condecimal
from datetime import date
from typing import Optional
from decimal import Decimal
from uuid import UUID

class IncomeCreate(BaseModel):
    category_id: Optional[UUID] = None
    category_name: Optional[str] = None
    amount: condecimal(max_digits=20, decimal_places=2)
    date: date
    emoji: Optional[str] = None

class IncomeUpdate(BaseModel):
    category_id: Optional[UUID] = None
    category_name: Optional[str] = None
    amount: Optional[condecimal(max_digits=20, decimal_places=2)] = None
    date: Optional[date] = None
    emoji: Optional[str] = None
```

## b) Routes (refactor income endpoints)

```python
from fastapi import status
from decimal import Decimal
from app.schema import IncomeCreate, IncomeOut, IncomeUpdate

@app.post("/incomes", response_model=IncomeOut, status_code=status.HTTP_201_CREATED)
def create_income(payload: IncomeCreate, current_user = Depends(get_current_user_db), db: Session = Depends(get_db)):
    try:
        income = crud.create_income(
            db=db,
            user_id=current_user.id,
            category_name=payload.category_name,
            amount=payload.amount,
            date_val=payload.date,
            emoji=payload.emoji,
            category_id=payload.category_id,
        )
    except Exception as e:
        # cụ thể hơn nếu bạn muốn bắt IntegrityError
        raise HTTPException(status_code=400, detail=f"Failed to create income: {str(e)}")
    return income

@app.get("/incomes", response_model=List[IncomeOut])
def list_incomes(
    current_user = Depends(get_current_user_db), 
    db: Session = Depends(get_db),
    from_date: Optional[date] = None,
    to_date: Optional[date] = None,
    limit: int = 100,
    offset: int = 0,
):
    incomes = crud.list_incomes_for_user(db, current_user.id, type_filter=None, from_date=from_date, to_date=to_date, limit=limit, offset=offset)
    return incomes

@app.put("/incomes/{income_id}", response_model=IncomeOut)
def update_income(income_id: UUID, payload: IncomeUpdate, current_user = Depends(get_current_user_db), db: Session = Depends(get_db)):
    # verify ownership inside crud.update_income or check here
    updated_income = crud.update_income(db, income_id, current_user.id, payload.dict(exclude_unset=True))
    if not updated_income:
        raise HTTPException(status_code=404, detail="Income not found or not permitted")
    return updated_income

@app.delete("/incomes/{income_id}", status_code=status.HTTP_204_NO_CONTENT)
def delete_income(income_id: UUID, current_user = Depends(get_current_user_db), db: Session = Depends(get_db)):
    deleted = crud.delete_income(db, income_id, current_user.id)
    if not deleted:
        raise HTTPException(status_code=404, detail="Income not found or not permitted")
    return None
```

## c) CRUD expectations (tóm tắt)

 `create_income(db, user_id, ...)` ⇒ tạo, commit, return created object (SQLAlchemy instance)
 `list_incomes_for_user(db, user_id, from_date, to_date, limit, offset)` ⇒ support filters/pagination
 `update_income(db, income_id, user_id, update_dict)` ⇒ chỉ update nếu `income.user_id == user_id`, commit, return updated object or `None`
 `delete_income(db, income_id, user_id)` ⇒ chỉ delete nếu owner, commit, return True/False

Nếu `crud` hiện tại chưa làm ownership check thì rất quan trọng phải thêm.

---

# 4) Các test cases bạn nên có (ít nhất)

 Tạo income thành công (201), response có các trường đúng
 Tạo income với amount precision >2 -> validation error
 List incomes filtered by dates
 Update income by owner -> success; update by other user -> 404 or 403
 Delete income by owner -> 204; delete by other -> 404/403
 Export endpoint trả file excel có tổng

---

# 5) Kết luận — hiện trạng & bước tiếp theo

 Hiện trạng: Backend đã có đầy đủ endpoints cho Income (CRUD + export).
 Cần làm: thêm/điều chỉnh nhỏ để đảm bảo:

   typed `IncomeUpdate` replace `dict` updates,
   ownership check cho update/delete,
   proper status codes (201, 204),
   filters & pagination cho `GET /incomes`,
   prefer Decimal type for money,
   add error handling + logging.






# services/chat_service.py
import os
from datetime import date
from langchain_google_genai import ChatGoogleGenerativeAI
from langchain.agents import AgentExecutor, create_tool_calling_agent
from langchain_core.prompts import ChatPromptTemplate
from sqlalchemy.orm import Session
from models import user_model
from services.chat_tools import get_finbot_tools
from cruds.crud_category import get_user_category_names_string


def process_chat_message(db: Session, user: user_model.User, user_message: str):
    # 1. Khởi tạo Gemini (Flash - Nhanh và Free)
    llm = ChatGoogleGenerativeAI(
        model="gemini-2.0-flash",
        temperature=0,
    )

    # 2. Lấy Tools và Context
    tools = get_finbot_tools(db, user)
    category_context = get_user_category_names_string(db, user.id)

    # 3. SYSTEM PROMPT (CỰC KỲ QUAN TRỌNG)
    SYSTEM_PROMPT = f"""
    Bạn là FinBot, trợ lý tài chính thông minh.
    Hôm nay là: {{current_date}} (Thứ {{weekday}}).

    {category_context}

    NHIỆM VỤ CỦA BẠN:

    1. **GHI CHÉP (create_transaction):**
       - Khi user muốn thêm tiền (VD: "ăn sáng 50k", "lương 10tr").
       - Tự động suy luận Type, Amount.
       - Chọn Category khớp với danh sách trên.

    2. **THỐNG KÊ (get_statistics):**
       - Khi user hỏi về quá khứ/hiện tại (VD: "tháng này tiêu gì", "tuần trước thu nhập bao nhiêu").
       - TỰ TÍNH NGÀY (dựa trên {{current_date}}):
         + "Tháng này": Từ ngày 1 tháng này -> Hôm nay.
         + "Tháng trước": Từ ngày 1 tháng trước -> Ngày cuối tháng trước.
         + "Tuần này": Từ Thứ 2 tuần này -> Hôm nay.

    3. **SỐ DƯ (get_balance):**
       - Khi user hỏi "còn bao nhiêu tiền", "tổng tài sản".

    QUY TẮC TRẢ LỜI:
    - Nếu gọi tool thành công: Báo kết quả ngắn gọn + Emoji.
    - Nếu là thống kê: Hãy đưa ra nhận xét ngắn (VD: "Bạn đã tiêu khá nhiều vào...").
    - Luôn dùng Tiếng Việt.
    """

    # 4. Tạo Prompt
    prompt = ChatPromptTemplate.from_messages([
        ("system", SYSTEM_PROMPT),
        ("human", "{input}"),
        ("placeholder", "{agent_scratchpad}"),
    ])

    # 5. Tạo Agent Executor
    agent = create_tool_calling_agent(llm, tools, prompt)
    agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=True)

    # 6. Thực thi (Inject ngày tháng)
    try:
        today = date.today()
        weekday_map = ["Hai", "Ba", "Tư", "Năm", "Sáu", "Bảy", "Chủ Nhật"]

        result = agent_executor.invoke({
            "input": user_message,
            "current_date": today.strftime("%Y-%m-%d"),
            "weekday": weekday_map[today.weekday()]
        })
        return result["output"]
    except Exception as e:
        return f"Xin lỗi, hệ thống đang bận: {str(e)}"




